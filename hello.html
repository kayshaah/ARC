<script>
  const toggle = document.getElementById('arcToggle');
  const stateEl = document.getElementById('arcState');
  const errEl = document.getElementById('err') || (()=>{const d=document.createElement('div');d.id='err';d.className='err';document.querySelector('.sub').appendChild(d);return d;})();

  function setUI(on) {
    toggle.checked = !!on;
    stateEl.textContent = on ? 'On' : 'Off';
  }

  function getActiveTab(cb) {
    chrome.tabs.query({ active: true, currentWindow: true }, tabs => cb(tabs[0]));
  }

  // On open, read persisted state and show it
  chrome.storage.local.get({ arcEnabled: true }, ({ arcEnabled }) => setUI(arcEnabled));

  // On change, persist and (if turning on) force-inject into current Amazon tab
  toggle.addEventListener('change', () => {
    const on = toggle.checked;
    chrome.storage.local.set({ arcEnabled: on }, () => {
      setUI(on);
      if (on) {
        chrome.runtime.sendMessage({ type: "ARC_FORCE_INJECT" }, (resp) => {
          if (chrome.runtime.lastError) return; // service worker asleep? ignore
          if (resp && !resp.ok) {
            errEl.textContent = "Open an Amazon product page with reviews, then toggle On.";
            errEl.style.display = 'block';
          } else {
            errEl.style.display = 'none';
          }
        });
      }
    });
  });
</script>
